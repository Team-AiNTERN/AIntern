<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AiNTERN ‚Äì Find Internships</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #0f172a;
      --primary-dark: #1e293b;
      --accent: #f39c12;
      --accent-dark: #e67e22;
      --bg: #f8fafc;
      --success: #27ae60;
      --error: #e74c3c;
      --warning: #f39c12;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 25px 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .logo {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 5px;
      color: var(--accent);
    }

    .tagline {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 25px;
    }

    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 25px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.4rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      margin-bottom: 10px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .filters select,
    .filters input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 0.95rem;
      background: white;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .filters select:focus,
    .filters input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.2);
    }

    .selected-list {
      margin-top: 15px;
      min-height: 40px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      background: var(--accent);
      color: white;
      padding: 6px 12px;
      margin: 5px 5px 0 0;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: default;
      animation: fadeIn 0.3s ease;
    }

    .chip button {
      background: transparent;
      border: none;
      color: white;
      margin-left: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.2s;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .results-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .internship-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .internship-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    }

    .internship-header {
      padding: 20px;
      background: var(--primary);
      color: white;
    }

    .internship-company {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 5px;
      color: var(--accent);
    }

    .internship-role {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .internship-body {
      padding: 20px;
      flex-grow: 1;
    }

    .internship-details {
      margin-bottom: 15px;
    }

    .detail-item {
      display: flex;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .detail-item .label {
      font-weight: 600;
      min-width: 120px;
      color: var(--primary);
    }

    .internship-footer {
      padding: 15px 20px;
      background: #f9fafc;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .apply-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .apply-btn:hover {
      background: var(--accent-dark);
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-live {
      background: var(--success);
    }

    .status-closed {
      background: var(--error);
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-style: italic;
      color: #666;
      grid-column: 1 / -1;
    }

    .connection-status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      animation: fadeIn 0.5s ease;
    }
    
    .connection-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .connection-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-icon {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .no-results i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }

    .results-count {
      margin-bottom: 15px;
      color: var(--primary);
      font-weight: 600;
    }

    .debug-info {
      background: #f1f3f6;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.85rem;
    }

    .debug-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">AiNTERN</div>
    <div class="tagline">Find the perfect internship with AI-powered matching</div>
  </header>

  <div class="container">
    <div id="connectionStatus" class="connection-status connection-success">
      <span class="status-icon">‚úÖ</span>
      <span>Successfully connected to Supabase database</span>
    </div>

    <div class="main">
      <div class="filters-column">
        <div class="card">
          <h2><span>üîç</span> Search & Filter</h2>
          <div class="filters">
            <div class="filter-group">
              <label for="searchInput">Keywords</label>
              <input type="text" id="searchInput" placeholder="Search internship role or company..." />
            </div>

            <div class="filter-group">
              <label for="degreeFilter">Degree</label>
              <select id="degreeFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select degree</option>
                <option>B.A.</option>
                <option>B.Com</option>
                <option>B.E.</option>
                <option>B.Sc.</option>
                <option>B.Tech</option>
                <option>BBA</option>
                <option>Diploma</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="languageFilter">Language</label>
              <select id="languageFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select language</option>
                <option>Hindi</option>
                <option>English</option>
                <option>Assamese</option>
                <option>Bengali</option>
                <option>Gujarati</option>
                <option>Kannada</option>
                <option>Kashmiri</option>
                <option>Malayalam</option>
                <option>Manipuri</option>
                <option>Marathi</option>
                <option>Nepali</option>
                <option>Odia</option>
                <option>Punjabi</option>
                <option>Sanskrit</option>
                <option>Sindhi</option>
                <option>Tamil</option>
                <option>Telugu</option>
                <option>Urdu</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="skillFilter">Skill</label>
              <select id="skillFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select skill</option>
                <option>Accounting</option>
                <option>CAD Design</option>
                <option>Cloud Computing</option>
                <option>Coding</option>
                <option>Financial Analysis</option>
                <option>Lab Skills</option>
                <option>Machine Learning</option>
                <option>Marketing</option>
                <option>Programming</option>
                <option>Research</option>
                <option>Robotics</option>
                <option>SEO</option>
                <option>UI/UX</option>
                <option>Writing</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="projectsFilter">Projects</label>
              <select id="projectsFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select projects</option>
                <option>0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="experienceFilter">Experience (Months)</label>
              <select id="experienceFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select experience</option>
                <option>0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="competitionsFilter">Coding Competitions</label>
              <select id="competitionsFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select competitions</option>
                <option>0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="specialisationFilter">Specialisation</label>
              <select id="specialisationFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select specialisation</option>
                <option>AI</option>
                <option>Biology</option>
                <option>Chemistry</option>
                <option>Commerce</option>
                <option>Computer Science</option>
                <option>Engineering</option>
                <option>Finance</option>
                <option>Genetics</option>
                <option>History</option>
                <option>IT</option>
                <option>Literature</option>
                <option>Marketing</option>
                <option>Mechanical Engineering</option>
                <option>Physics</option>
                <option>Sociology</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="domainFilter">Domain</label>
              <select id="domainFilter" onchange="addFilter(this)">
                <option value="" disabled selected>Select domain</option>
                <option>Consulting</option>
                <option>Data Analytics</option>
                <option>Design</option>
                <option>Engineering</option>
                <option>Finance</option>
                <option>HR</option>
                <option>IT</option>
                <option>Marketing</option>
                <option>Operations</option>
                <option>R&D</option>
              </select>
            </div>
          </div>

          <div class="selected-list" id="selectedFilters"></div>
          <button class="search-btn" onclick="searchInternships()"><span>‚ö°</span> Search Internships</button>

          <div class="debug-info">
            <div class="debug-title">Database Information</div>
            <div>Using Supabase URL: https://xozzpzasbdvgpyysuvew.supabase.co</div>
            <div>Table: internships</div>
            <div>Using correct column names from your database structure</div>
          </div>
        </div>
      </div>

      <div class="results-column">
        <div class="card">
          <h2><span>üíº</span> Available Internships</h2>
          <div class="results-count" id="resultsCount">Loading internships...</div>
          <div class="results-container" id="internshipResults">
            <div class="loading">Loading internships from database...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://xozzpzasbdvgpyysuvew.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvenpwemFzYmR2Z3B5eXN1dmV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MDA0NjMsImV4cCI6MjA3MzI3NjQ2M30.SiiaH38cNz21EHpvGOZNQCQ5vW2f6H2GBocGn4qYfGM';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global variables
    const selected = [];
    let searchInFlight = false;
    let searchController = null;

    // Column name mapping based on your database structure
    const columnMap = {
      company: "Company Name",
      location: "Company Location",
      role: "Internship Type", // Assuming this is the correct column
      degree: "Degree",
      specialization: "Specialization",
      languages: "Languages Known",
      skills: "Skills",
      experience: "Past Experience (months)",
      workLocation: "Preferred Work Location",
      projects: "Projects",
      competitions: "Competitions",
      stipend: "Internship Stipend (¬£/month)",
      duration: "Internship Duration (months)",
      department: "Department",
      email: "Contract Email",
      phone: "Contract Phone",
      deadline: "Application Deadline"
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Load internships when page loads
      searchInternships();
    });

    // Add filter to selected list
    function addFilter(select) {
      const value = select.value;
      const filterType = select.id.replace('Filter', '');
      
      if (value && !selected.some(item => item.value === value && item.type === filterType)) {
        selected.push({ value, type: filterType });
        updateSelectedList();
      }
      select.selectedIndex = 0;
    }

    // Update the selected filters display
    function updateSelectedList() {
      const container = document.getElementById("selectedFilters");
      container.innerHTML = "";
      
      if (selected.length === 0) {
        container.innerHTML = "<div style='color: #666; font-style: italic;'>No filters selected</div>";
        return;
      }
      
      selected.forEach((item, index) => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `${item.type}: ${item.value} <button onclick="removeFilter(${index})">&times;</button>`;
        container.appendChild(chip);
      });
    }

    // Remove a filter from the selected list
    function removeFilter(index) {
      selected.splice(index, 1);
      updateSelectedList();
    }

    // Main search function
    async function searchInternships() {
      if (searchInFlight && searchController) {
        try { searchController.abort(); } catch (_) {}
      }
      
      searchInFlight = true;
      searchController = new AbortController();

      const results = document.getElementById("internshipResults");
      const resultsCount = document.getElementById("resultsCount");
      const query = document.getElementById("searchInput").value.trim();
      
      results.innerHTML = "<div class='loading'>Searching internships...</div>";
      
      try {
        const btn = document.querySelector('.search-btn');
        if (btn) { 
          btn.disabled = true; 
          btn.innerHTML = "<span>‚è≥</span> Searching..."; 
        }

        // Build the Supabase query using correct column names
        let supabaseQuery = supabase
          .from('internships')
          .select('*');
        
        // Apply text search if query exists
        if (query) {
          // Search in both Company Name and Internship Type columns
          supabaseQuery = supabaseQuery.or(`${columnMap.company}.ilike.%${query}%,${columnMap.role}.ilike.%${query}%`);
        }
        
        // Apply filters using correct column names
        selected.forEach(filter => {
          const columnName = columnMap[filter.type] || filter.type;
          supabaseQuery = supabaseQuery.ilike(columnName, `%${filter.value}%`);
        });
        
        // Execute the query
        const { data: internships, error } = await supabaseQuery;
        
        if (error) {
          console.error("Supabase error:", error);
          throw error;
        }
        
        // Display results
        displayResults(internships || []);
        
      } catch (err) {
        const aborted = err && err.name === 'AbortError';
        if (!aborted) {
          console.error("Supabase query error:", err);
          results.innerHTML = "<div class='no-results'><div>‚ùå</div><div>Failed to load internships. Please check your connection and try again.</div><div style='font-size: 0.9rem; margin-top: 10px;'>Error: " + err.message + "</div></div>";
          resultsCount.textContent = "Error loading results";
          
          // Update connection status
          const statusEl = document.getElementById('connectionStatus');
          statusEl.className = 'connection-status connection-error';
          statusEl.innerHTML = "<span class='status-icon'>‚ùå</span><span>Error connecting to Supabase: " + err.message + "</span>";
        }
      } finally {
        searchInFlight = false;
        const btn = document.querySelector('.search-btn');
        if (btn) { 
          btn.disabled = false; 
          btn.innerHTML = "<span>‚ö°</span> Search Internships"; 
        }
      }
    }
    
    // Display results in the UI
    function displayResults(internships) {
      const results = document.getElementById("internshipResults");
      const resultsCount = document.getElementById("resultsCount");
      
      if (!internships || internships.length === 0) {
        results.innerHTML = `
          <div class="no-results">
            <div>üîç</div>
            <h3>No internships found</h3>
            <p>Try adjusting your search criteria or filters</p>
          </div>
        `;
        resultsCount.textContent = "No internships found";
        return;
      }
      
      resultsCount.textContent = `Found ${internships.length} internship${internships.length !== 1 ? 's' : ''}`;
      
      // Clear previous results
      results.innerHTML = '';
      
      // Add each internship to the results
      internships.forEach(internship => {
        const card = document.createElement('div');
        card.className = 'internship-card';
        
        // Use the correct column names from your database
        const company = internship[columnMap.company] || 'Unknown Company';
        const role = internship[columnMap.role] || 'Internship Role';
        const location = internship[columnMap.location] || 'Not specified';
        const stipend = internship[columnMap.stipend] ? '‚Çπ' + internship[columnMap.stipend] : 'Unpaid';
        const duration = internship[columnMap.duration] || 'Not specified';
        const skills = internship[columnMap.skills] || 'Not specified';
        
        card.innerHTML = `
          <div class="internship-header">
            <div class="internship-company">${company}</div>
            <div class="internship-role">${role}</div>
          </div>
          <div class="internship-body">
            <div class="internship-details">
              <div class="detail-item">
                <span class="label">Location:</span>
                <span>${location}</span>
              </div>
              <div class="detail-item">
                <span class="label">Stipend:</span>
                <span>${stipend}</span>
              </div>
              <div class="detail-item">
                <span class="label">Duration:</span>
                <span>${duration}</span>
              </div>
              <div class="detail-item">
                <span class="label">Skills:</span>
                <span>${skills}</span>
              </div>
            </div>
          </div>
          <div class="internship-footer">
            <div>
              <span class="status-indicator status-live"></span>
              <span>Accepting Applications</span>
            </div>
            <button class="apply-btn">Apply Now</button>
          </div>
        `;
        
        results.appendChild(card);
      });
    }
  </script>
</body>
</html>
